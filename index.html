<!DOCTYPE html>
<html>
    <head>
    </head>
    <body>
        <input type="file" class="file-input" id="fileInput" style="background:#0cf;width:800px;height:400px;">
  
        <script src="node_modules/pako/dist/pako.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="node_modules/three/build/three.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="build/bundle.js" type="text/javascript" charset="utf-8"></script>
        <script>
            var DIVA = require("DIVA");
            fileInput.addEventListener('change', function () {
                console.time("load file")
                const reader = new FileReader();
                reader.readAsArrayBuffer(this.files[0]);
                reader.addEventListener('load', function () {
                    console.timeEnd("load file")
                    console.time("extract farc")
                    var ret = DIVA.FarcArchive.Read(reader.result);
                    console.timeEnd("extract farc")
                    console.log(ret)
                    if (ret[0].fname.endsWith("_obj.bin") && ret[1].fname.endsWith("_tex.bin")){
                        console.time("loading objects")
                        var re = DIVA.ObjectSet.Read(ret[0].content.buffer);
                        var texid = re[1];
                        var obj = re[0];
                        console.timeEnd("loading objects")
                        console.time("loading textures")
                        var tex = DIVA.TextureSet.Read(ret[1].content.buffer);
                        console.timeEnd("loading textures")
                        console.log(obj)
                        console.log(tex)
                        window.DIVAobj = obj;
                        window.DIVAtex = [];
                        for (var i in texid){
                            window.DIVAtex[texid[i]] = tex[i];
                        }
                        window.testf();
                    }
                }, false);
            });
    </script>
    <script type="module">
        var THREE = window.THREE;
        import Stats from './node_modules/three/examples/jsm/libs/stats.module.js';
        import { TrackballControls } from './node_modules/three/examples/jsm/controls/TrackballControls.js';
            var camera, scene, renderer, controls, stats;

        function test(){
            init();
            animate();
        }
        window.testf = test;
            function init() {
				var canvas = document.createElement( 'canvas' );
				var context = canvas.getContext( 'webgl2', { alpha: false, antialias: true } );

                renderer = new THREE.WebGLRenderer( { canvas: canvas, context: context });
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize( window.innerWidth, window.innerHeight );
                document.body.appendChild( renderer.domElement );
                scene = new THREE.Scene();
                const fov = 75;
                const aspect = 2; 
                const near = 0.1;
                const far = 100;
                camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
                camera.position.z = 5;
                scene.add( camera );
                controls = new TrackballControls( camera, renderer.domElement );
                controls.minDistance = 0.1;
                controls.maxDistance = 8.0;
                controls.dynamicDampingFactor = 0.1;
                scene.add( new THREE.AmbientLight( 0xffffff, 0.2 ) );
                var light = new THREE.PointLight( 0xffffff, 0.7 );
                camera.add( light );
                createScene();
                stats = new Stats();
                document.body.appendChild( stats.dom );
                window.addEventListener( 'resize', onWindowResize, false );
            }
            function loadTexture(tex){
                var map = new THREE.CompressedTexture();
                map.mipmaps = [];
                switch (tex.SubTextures[0][0].Format){
                    case 6: map.format = THREE.RGB_S3TC_DXT1_Format;break;
                    case 9: map.format = THREE.RGBA_S3TC_DXT5_Format;break;
                    default: throw "Unsupported format: "+tex.SubTextures[0][0].Format;
                }
                for (var i = 0; i < tex.MipMapCount; i++)
                    map.mipmaps.push({
                        "width": tex.SubTextures[0][i].Width,
                        "height": tex.SubTextures[0][i].Height,
                        "data": tex.SubTextures[0][i].Data
                    })
                map.image.width = map.mipmaps[0].width;
                map.image.height = map.mipmaps[0].height;
                map.version = 1;
                return map;
            }
            function createScene() {
                for (var obj of window.DIVAobj){
                    for(var mesh of obj.Meshes){
                        var bufferGeometry = new THREE.BufferGeometry();
                        bufferGeometry.setAttribute( 'position', new THREE.Float32BufferAttribute( mesh.Vertex, 3 ) );
                        bufferGeometry.setAttribute( 'normal', new THREE.Float32BufferAttribute( mesh.Normal, 3 ) );
                        bufferGeometry.setAttribute( 'uv', new THREE.Float32BufferAttribute( mesh.UVChannel1, 2 ) );
                        bufferGeometry.setAttribute( 'tangent', new THREE.Float32BufferAttribute( mesh.Tangent, 4 ) );
                        bufferGeometry.setIndex(mesh.SubMeshes[0].Indices);

                        var materialdata = obj.Materials[mesh.SubMeshes[0].MaterialIndex];
                        var material;
                        console.log("Loading mesh "+mesh.Name+": type "+materialdata.Shader);
                        
                        //map:Diffuse normalMap:Normal envMap:Reflection specularMap:Specular shininess:Shininess

                        var shininess = materialdata.Shininess;
                        var params = {shininess, color:0xffffff};

                        if(materialdata.Diffuse.TextureId != -1){
                            var Diffuse = window.DIVAtex[materialdata.Diffuse.TextureId];
                            params.map = loadTexture(Diffuse);
                        }

                        if(materialdata.Normal.TextureId != -1){
                            var Normal = window.DIVAtex[materialdata.Normal.TextureId];
                            // TODO - ATI2 decode
                            //params.normalMap = loadTexture(Normal);
                        }
                        
                        if(materialdata.Specular.TextureId != -1){
                            var Specular = window.DIVAtex[materialdata.Specular.TextureId];
                            params.specularMap = loadTexture(Specular);
                        }
                        
                        if(materialdata.Reflection.TextureId != -1){
                            var Reflection = window.DIVAtex[materialdata.Reflection.TextureId];
                            // TODO - map6
                            //params.envMap = loadTexture(Reflection);
                        }
                        

                        material = new THREE.MeshPhongMaterial(params);


                        var mes = new THREE.Mesh( bufferGeometry, material );
                        mes.drawMode = THREE.TriangleStripDrawMode;
                        scene.add( mes );
                    }
                }
            }
            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize( window.innerWidth, window.innerHeight );
            }
            function animate() {
                requestAnimationFrame( animate );
                controls.update();
                stats.update();
                renderer.render( scene, camera );
            }

        </script>
    </body>
</html>