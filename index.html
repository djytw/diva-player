<!DOCTYPE html>
<html>
    <head>
        <style>
            *{
                margin:0;
                padding:0;
            }
            #main_display{
                width:100vw;
                height:100vh;
                background:transparent;
                z-index:1;
                position:absolute;
                display: flex;
                text-align: center;
                justify-content: center;
                align-items: center;
                font-size: 30px;
            }
            #main_log{
                max-height:100vh;
                overflow-y:scroll;
                width:100vh;
                background:transparent;
                border:0;
                color:black;
                position:absolute;
                left: 0px;
                bottom: 0px;
                min-height: 1rem;
                font-size:10px;
                z-index:0;
                font-family: Cascadia, Consolas, 'Ubuntu Mono', monospace;
            }
            #main_log::-webkit-scrollbar{
                width:0px;
            }
            body{
                background: #ccc;
            }
        </style>
    </head>
    <body>
        <div id="main_display" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">Please drag&drop .farc files here</div>
        <pre id="main_log"></pre>
        <script src="node_modules/pako/dist/pako.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="node_modules/three/build/three.js" type="text/javascript" charset="utf-8"></script>
        <script src="build/bundle.js" type="text/javascript" charset="utf-8"></script>
        <script src="node_modules/three/examples/js/libs/stats.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="node_modules/three/examples/js/loaders/DDSLoader.js" type="text/javascript" charset="utf-8"></script>
        <script src="node_modules/three/examples/js/controls/TrackballControls.js" type="text/javascript" charset="utf-8"></script>
        <script>
            var DIVA = require("DIVA");
            var camera, scene, renderer, controls, stats;

            function dropHandler(ev) {
                ev.preventDefault();
                if (ev.dataTransfer.items) {
                    for (var i = 0; i < ev.dataTransfer.items.length; i++) {
                        if (ev.dataTransfer.items[i].kind === 'file') {
                            var file = ev.dataTransfer.items[i].getAsFile();
                            openFile(file);
                            break;
                        }
                    }
                }
            }
            function mlog(str){
                document.getElementById("main_log").innerHTML += str + "\n";
            }
            function timeStart(str){
                if (window.timeCount == undefined){
                    window.timeCount = [];
                }
                window.timeCount[str] = new Date().getTime();
            }
            function timeEnd(str){
                end = new Date().getTime();
                if (window.timeCount[str] == undefined){
                    mlog("Undefined timer: " + str);
                    return;
                }
                mlog(str + ": " + (end - window.timeCount[str]) + "ms");
            }
            function dragOverHandler(ev) {
                ev.preventDefault();
            }
            function openFile(file) {
                timeStart("load file");
                const reader = new FileReader();
                reader.readAsArrayBuffer(file);
                reader.addEventListener('load', function () {
                    timeEnd("load file")
                    timeStart("extract farc")
                    var ret = DIVA.FarcArchive.Read(reader.result);
                    timeEnd("extract farc")
                    str = "farc contains " + ret.length + " files: ";
                    for (f of ret) str += f.fname + ", ";
                    mlog(str);
                    if (ret[0].fname.endsWith("_obj.bin") && ret[1].fname.endsWith("_tex.bin")){
                        timeStart("loading objects")
                        var re = DIVA.ObjectSet.Read(ret[0].content.buffer);
                        var texid = re[1];
                        var obj = re[0];
                        timeEnd("loading objects")
                        timeStart("loading textures")
                        var tex = DIVA.TextureSet.Read(ret[1].content.buffer);
                        timeEnd("loading textures")
                        console.log(obj)
                        console.log(tex)
                        window.DIVAobj = obj;
                        window.DIVAtex = [];
                        for (var i in texid){
                            window.DIVAtex[texid[i]] = tex[i];
                        }
                        init();
                        animate();
                    }
                }, false);
            }

            function init() {
                mlog("start initialize stage")
				var canvas = document.createElement( 'canvas' );
				var context = canvas.getContext( 'webgl2', { alpha: true, antialias: true } );

                renderer = new THREE.WebGLRenderer( { canvas: canvas, context: context, alpha: true });
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize( window.innerWidth, window.innerHeight );
                renderer.setClearColor(0xffffff, 0);
                document.getElementById("main_display").innerHTML = "";
                document.getElementById("main_display").appendChild(renderer.domElement)
                scene = new THREE.Scene();
                const fov = 75;
                const aspect = 2; 
                const near = 0.1;
                const far = 100;
                camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
                camera.position.z = 2;
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                scene.add( camera );
                controls = new THREE.TrackballControls( camera, renderer.domElement );
                controls.minDistance = 0.1;
                controls.maxDistance = 8.0;
                controls.dynamicDampingFactor = 0.1;
                scene.add( new THREE.AmbientLight( 0xffffff, 0.2 ) );
                var light = new THREE.PointLight( 0xffffff, 0.7 );
                camera.add( light );
                createScene();
                stats = new Stats();
                document.body.appendChild( stats.dom );
                window.addEventListener( 'resize', onWindowResize, false );
            }
            function loadTexture(tex){
                switch (tex.SubTextures[0][0].Format){
                    case 6: case 9: return loadCompressedTexture(tex);break;
                    case 11: return loadUncompressedTexture(tex);break;
                    default: 
                    mlog( "Unsupported format: "+tex.SubTextures[0][0].Format);
                    return null;
                }
            }
            function loadCompressedTexture(tex){
                var map = new THREE.CompressedTexture();
                map.mipmaps = [];
                if (tex.SubTextures[0][0].Format == 6)
                    map.format = THREE.RGB_S3TC_DXT1_Format;
                else 
                    map.format = THREE.RGBA_S3TC_DXT5_Format;

                for (var i = 0; i < tex.MipMapCount; i++)
                    map.mipmaps.push({
                        "width": tex.SubTextures[0][i].Width,
                        "height": tex.SubTextures[0][i].Height,
                        "data": tex.SubTextures[0][i].Data
                    })
                map.image.width = map.mipmaps[0].width;
                map.image.height = map.mipmaps[0].height;
                map.version = 1;
                return map;
            }
            function loadUncompressedTexture(tex) {
                if( tex.SubTextures[0][0].Width != tex.SubTextures[0][0].Height)return;
                var map = new THREE.DataTexture(DIVA.BC5.decode(tex.SubTextures[0][0].Data,tex.SubTextures[0][0].Width),tex.SubTextures[0][0].Width,tex.SubTextures[0][0].Width,THREE.RGBFormat );
                return map;
            }
            function createScene() {
                for (var obj of window.DIVAobj){
                    for(var mesh of obj.Meshes){
                        var bufferGeometry = new THREE.BufferGeometry();
                        bufferGeometry.setAttribute( 'position', new THREE.Float32BufferAttribute( mesh.Vertex, 3 ) );
                        bufferGeometry.setAttribute( 'normal', new THREE.Float32BufferAttribute( mesh.Normal, 3 ) );
                        bufferGeometry.setAttribute( 'uv', new THREE.Float32BufferAttribute( mesh.UVChannel1, 2 ) );
                        bufferGeometry.setAttribute( 'tangent', new THREE.Float32BufferAttribute( mesh.Tangent, 4 ) );
                        bufferGeometry.setIndex(mesh.SubMeshes[0].Indices);

                        var materialdata = obj.Materials[mesh.SubMeshes[0].MaterialIndex];
                        var material;
                        mlog("----\nLoading mesh "+mesh.Name+": type "+materialdata.Shader);
                        
                        //map:Diffuse normalMap:Normal envMap:Reflection specularMap:Specular shininess:Shininess

                        var shininess = materialdata.Shininess;
                        var params = {shininess, color:0xffffff};

                        if(materialdata.Diffuse.TextureId != -1){
                            //mlog("Loading Diffuse map.")
                            var Diffuse = window.DIVAtex[materialdata.Diffuse.TextureId];
                            params.map = loadTexture(Diffuse);
                            if (Diffuse.SubTextures[0][0].Format == 9 && materialdata.Shader =="ITEM"){
                                params.blending = THREE.AdditiveBlending;
                            }
                            if (Diffuse.SubTextures[0][0].Format == 9 && materialdata.Shader =="CLOTH"){
                                params.blending = THREE.AdditiveBlending;
                                params.side=THREE.DoubleSide
                            }
                            if (Diffuse.SubTextures[0][0].Format == 9)
                                params.transparent=true
                        }

                        if(materialdata.Normal.TextureId != -1){
                            var Normal = window.DIVAtex[materialdata.Normal.TextureId];
                            //mlog("Loading Normal map.")
                            params.normalMap = loadTexture(Normal);
                        }
                        
                        if(materialdata.Specular.TextureId != -1){
                            var Specular = window.DIVAtex[materialdata.Specular.TextureId];
                            //mlog("Loading Specular map.")
                            params.specularMap = loadTexture(Specular);
                        }
                        
                        if(materialdata.Reflection.TextureId != -1){
                            var Reflection = window.DIVAtex[materialdata.Reflection.TextureId];
                            //mlog("Loading envMap map.")
                            //params.envMap = loadTexture(Reflection);
                        }
                        

                        material = new THREE.MeshPhongMaterial(params);


                        var mes = new THREE.Mesh( bufferGeometry, material );
                        mes.drawMode = THREE.TriangleStripDrawMode;
                        scene.add( mes );
                    }
                }
            }
            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize( window.innerWidth, window.innerHeight );
            }
            function animate() {
                requestAnimationFrame( animate );
                controls.update();
                stats.update();
                renderer.render( scene, camera );
            }

        </script>
    </body>
</html>