<!DOCTYPE html>
<html>
    <head>
    </head>
    <body>
        <input type="file" class="file-input" id="fileInput" style="background:#0cf;width:800px;height:400px;">
  
        <script src="node_modules/pako/dist/pako.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="node_modules/three/build/three.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="build/bundle.js" type="text/javascript" charset="utf-8"></script>
        <script>
            var DIVA = require("DIVA");
            fileInput.addEventListener('change', function () {
                console.time("load file")
                const reader = new FileReader();
                reader.readAsArrayBuffer(this.files[0]);
                reader.addEventListener('load', function () {
                    console.timeEnd("load file")
                    console.time("extract farc")
                    var ret = DIVA.FarcArchive.Read(reader.result);
                    console.timeEnd("extract farc")
                    console.log(ret)
                    if (ret[0].fname.endsWith("_obj.bin")){
                        console.time("loading objects")
                        var obj = DIVA.ObjectSet.Read(ret[0].content.buffer);
                        console.timeEnd("loading objects")
                        console.log(obj)
                        window.mes = obj[0].Meshes[0];
                        window.testf();
                    }
                }, false);
            });
    </script>
    <script type="module">
        var THREE = window.THREE;
        import Stats from './node_modules/three/examples/jsm/libs/stats.module.js';
        import { TrackballControls } from './node_modules/three/examples/jsm/controls/TrackballControls.js';
			var camera, scene, renderer, controls, stats;

        function test(){
            init();
            animate();
        }
        window.testf = test;
			function init() {
				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.body.appendChild( renderer.domElement );
				scene = new THREE.Scene();
                const fov = 75;
                const aspect = 2; 
                const near = 0.1;
                const far = 100;
                camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
                camera.position.z = 5;
				scene.add( camera );
				controls = new TrackballControls( camera, renderer.domElement );
				controls.minDistance = 0.1;
				controls.maxDistance = 8.0;
				controls.dynamicDampingFactor = 0.1;
				scene.add( new THREE.AmbientLight( 0xffffff, 0.2 ) );
				var light = new THREE.PointLight( 0xffffff, 0.7 );
				camera.add( light );
				createScene();
				stats = new Stats();
				document.body.appendChild( stats.dom );
				window.addEventListener( 'resize', onWindowResize, false );
			}
			function createScene() {
				var bufferGeometry = new THREE.BufferGeometry();
				bufferGeometry.setAttribute( 'position', new THREE.Float32BufferAttribute( window.mes.Vertex, 3 ) );
				bufferGeometry.setAttribute( 'normal', new THREE.Float32BufferAttribute( window.mes.Normal, 3 ) );
                bufferGeometry.setAttribute( 'uv', new THREE.Float32BufferAttribute( window.mes.UVChannel, 2 ) );
                bufferGeometry.setAttribute( 'tangent', new THREE.Float32BufferAttribute( window.mes.Tangent, 4 ) );
                bufferGeometry.setIndex(window.mes.SubMeshes[0].Indices);
				var material = new THREE.MeshPhongMaterial( { shininess: 80, color:0xffffff } );
                var mesh = new THREE.Mesh( bufferGeometry, material );
                mesh.drawMode = THREE.TriangleStripDrawMode;
				scene.add( mesh );
			}
			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
			}
			function animate() {
				requestAnimationFrame( animate );
				controls.update();
				stats.update();
				renderer.render( scene, camera );
			}

        </script>
    </body>
</html>